<div class="edits editing-form">

  <!-- begin validation error -->
  <div class="alert alert-dismissible alert-danger validation" ng-show="errors.length > 0">
    <button class="btn btn-default md md-close pull-right white" ng-click="errors = []" style="background: transparent"
            tabindex="0"></button>
    <h4>Error!</h4>

    <div ng-repeat="error in errors">
      {{error}}
    </div>
  </div>
  <div class="alert alert-dismissible alert-warning validation" ng-show="warnings.length > 0">
    <button class="btn btn-default md md-close pull-right white" ng-click="warnings = []"
            style="background: transparent" tabindex="0"></button>
    <h4>Warning!</h4>

    <div ng-repeat="warning in warnings">
      {{warning}}
    </div>
  </div>

  <!-- end validation error -->
  <!-- The concept itself -->
  <div class="row p-t-5 grey darken-4 concept-headers" style="margin-right:0px;">
    <div class="pull-left col-md-1 no-padding">

      <!--   <button ng-click="setDescriptionProperties(description, $event)"
                  class="btn-default grey darken-3 md morebuttons fa fa-ellipsis-v more-button-width tooltips-left tooltips-light normal-case"
                  popover-template="'shared/component-more/descriptionMore.html'"
                  popover-placement="{{popoverDirection}}"
                  ng-click="populateDescriptionMore(description)" popover-append-to-body="true">
            <span>More details</span></button>

            -->

      <button ng-click="setConceptProperties(concept, $event)" type="button" id="conceptMoreButton"
              class="btn btn-default morebuttons grey darken-4 md fa fa-ellipsis-v more-button-width tooltips-left tooltips-light normal-case"
              popover-template="'shared/component-more/conceptMore.html'" popover-placement="{{popoverDirection}}"
              popover-trigger="click: click" popover-append-to-body="true"><span>More details</span></button>

      <button
        class="btn btn-default morebuttons grey darken-4 md md-open-with normal-case drag-button-width "
        ui-draggable="true" drag="getConceptIdNamePair(concept)" drag-channel="conceptPropertiesObj"
        drop-channel="NA" drag-image="getDragImageForConcept(concept.fsn)"></button>

      <button type="button"
              class="btn-default save-button small-buttons red lighten-2 md md-assignment-turned-in tooltips-left tooltips-light normal-case "
              ng-click="saveConcept()"
              ng-if="isMerge"><span> Accept Merged Version </span></button>

    </div>

    <!-- concept name -->
    <div class="pull-left col-md-6 no-padding title-text">
      <button type="button" class="btn-default grey darken-4 title-text fsn-title-button">
        <span class="fsn p-t-5">{{concept.fsn}}</span>

          <span
            ng-show="!concept.fsn && !concept.effectiveTime" style="color:grey">Unsaved Concept</span></button>
    </div>

    <div class="pull-right m-l-4 m-r-5 col-md-1 no-padding ">
      <!--
            <select name="select-primitive-choice" id="select-primitive-choice"
                    ng-disabled="isStatic"
                    ng-model="concept.definitionStatus"
                    ng-change="toggleConceptDefinitionStatus()"
                    class="form-control grey darken-4 primitive pull-left"
                    style="width:30px;"
                    ng-options="definitionStatus.id as definitionStatus.name for definitionStatus in definitionStatuses">
            </select>
      -->
      <button ng-if="concept.definitionStatus == 'FULLY_DEFINED'"
              class="pull-left p-t-5 p-l-3 white-text primitive-buttons tooltips-left tooltips-light normal-case">
        <div class="badge alert-warning ng-binding" ng-click="toggleConceptDefinitionStatus()">â‰¡&nbsp; </div>
        <span>Concept is Fully Defined</span></button>
      <button ng-if="concept.definitionStatus == 'PRIMITIVE'"
              class="pull-left  p-t-5 p-l-3 primitive-buttons white-text tooltips-left tooltips-light normal-case">
        <div class="badge alert-warning ng-binding" ng-click="toggleConceptDefinitionStatus()">&nbsp; </div>
        <span>Concept is Primitive</span></button>

      <div class="pull-right">
        <button ng-init="isCollapsed = false" ng-click="collapse(concept)" type="button"
                ng-class="[btn, btn-default, darkbuttons, grey, 'darken-4', 'toggle-buttons', md, {'fa fa-caret-down' : isCollapsed, ' fa fa-caret-up' : !isCollapsed}]"></button>
      </div>
    </div>
    <div class="pull-right no-margin edits concept-title col-md-4 no-padding">
      <button type="button"
              class="btn-default save-button small-buttons deep-purple lighten-2 md md-save tooltips-left tooltips-light normal-case "
              ng-click="saveConcept()"
              ng-if="isModified && !isStatic"><span> Save Concept </span></button>
      <!-- Revert button only appears if parent is specified -->
      <button ng-if="parentBranch" type="button" class="btn btn-default revert-button" ng-click="revertConcept()">
        Revert
      </button>

      <!-- control buttons -->
      <button type="button"
              style="vertical-align: bottom"
              ng-class="[btn-default, editbuttons, ' fa fa-power-off', {green : concept.active}, {red: !concept.active}]"
              ng-click="toggleConceptActive(concept)" class="small-buttons tooltips-left tooltips-light normal-case">
        <span ng-if="!isStatic"> Activate/ inactivate concept </span>
        <span ng-if="isStatic"> {{concept.active ? 'Active Concept' : 'InactiveConcept'}} </span></button>
      <button type="button"
              style="vertical-align: bottom"
              class="btn-default editbuttons small-buttons  tooltips-left tooltips-light normal-case"
              ng-class="[{'red fa fa-level-down' : !hideInactive}, {'fa fa-level-up green' : hideInactive}]"
              ng-click="toggleHideInactive()"><span> Show/hide inactive components </span></button>


      <button type="button" class="btn-default editbuttons small-buttons amber md md-undo "
              title="Undo Changes"
              ng-click="undo()"
              ng-disabled="conceptHistoryPtr < 1"
              ng-if="!isStatic"></button>
      <button type="button" class="btn-default editbuttons small-buttons amber md md-redo "
              title="Redo Changes"
              ng-click="redo()"
              ng-if="!isStatic"
              ng-disabled="conceptHistoryPtr === conceptHistory.length - 1"></button>
      <button type="button" class="btn-default editbuttons small-buttons deep-purple lighten-2 md md-history"
              title="Revert to Saved"
              ng-click="undoAll()"
              ng-if="!isStatic"
              ng-disabled="!isModified"></button>
      <button type="button"
              class="btn-default editbuttons small-buttons blue tooltips-left tooltips-light normal-case md fa fa-sitemap"
              title="Show/Hide Model"
              ng-if="!isStatic"
              ng-click="showModel(concept)"><span ng-if="modelVisible"> Hide Model </span><span
        ng-if="!modelVisible"> Show Model </span></button>
      <button type="button"
              class="btn-default editbuttons small-buttons orange darken-3 md fa fa-close tooltips-left tooltips-light normal-case"
              ng-click="removeConcept(concept)"><span>Remove concept from edit panel</span></button>
      <div ng-repeat="field in concept.additionalFields">
            <textarea class="msd-elastic resizable-text"
                      ng-model-options="{updateOn: 'blur'}"
                      ng-model="field.value" type="text"
                      placeholder="{{field}}">
            </textarea>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="validation red" ng-repeat="error in validation.errors[concept.conceptId]"><strong>Convention
                                                                                                  Error:</strong>
      {{error}}
    </div>
  </div>
  <div class="row">
    <div class="validation orange darken-1" ng-repeat="warning in validation.warnings[concept.conceptId]"><strong>Convention
                                                                                                                  Warning:</strong>
      {{warning}}
    </div>
  </div>


  <!-- Toggle-able collapsed concept elements -->
  <div ng-show="!isCollapsed" class="editHeightSelector ">


    <!-- rows: Concept Descriptions -->
    <div ng-repeat="description in getDescriptions()"
         ng-class="getComponentStyle(description.descriptionId, null, '')" class="">

      <div class="row darken-3 p-t-5 grey dividercolor_{{relationship.groupId}}">
        <div class="col-md-12 no-padding color_{{relationship.groupId}} "
             drop-channel="descriptionObj"
             ui-on-drop="dropDescription(description, $data)"
             drag-enter-class="sca-drag-target"
             drag-hover-class="sca-drag-hover">

          <button ng-click="setDescriptionProperties(description, $event)"
                  class="btn-default grey darken-3 md morebuttons fa fa-ellipsis-v more-button-width tooltips-left tooltips-light normal-case"
                  popover-template="'shared/component-more/descriptionMore.html'"
                  popover-placement="{{popoverDirection}}"
                  popover-append-to-body="true">
            <span>More details</span></button>

          <button
            class="btn-default grey darken-3 md morebuttons md-open-with drag-button-width"
            ui-draggable="true" drag="description" drag-channel="descriptionObj"
            drag-image="getDragImageForDescription(description)"></button>

          <!-- Active/Inactive -->
          <button type="button"
                  style="vertical-align: bottom"
                  ng-disabled="isStatic"
                  ng-click="toggleDescriptionActive(description)"
                  ng-class="[btn-default, md, 'fa fa-power-off button-width', {green : description.active}, {red: !description.active}]"
                  title="Active/Inactive"></button>

          <!-- Case Significance -->
          <button type="button"
                  class=" blue accent-2 button-width custom-button text-center tooltips-right tooltips-light normal-case"
                  ng-disabled="isStatic"
                  ng-click="toggleCaseSignificance(description)">

            <div class="text-center">{{getCaseSignificanceDisplayText(description)}}</div>

            <span><div class="{{getCaseSignificanceDisplayText(description)}}"></div></span>
          </button>

          <!-- Term -->
          <div class="pull-left description no-padding"
               ng-class="getComponentStyle(description.descriptionId, 'term', null)">



            <textarea ng-if="description.type === 'FSN'" ng-change="updateDescription(description)"
                      ng-model-options="{updateOn: 'blur'}"
                      ng-disabled="isStatic || description.effectiveTime"
                      maxlength="255"
                      ng-model="description.term"
                      class="color_{{relationship.groupId}} msd-elastic" 
                      type="text"
                      placeholder="Description" >
            </textarea>

            <textarea ng-if="description.type === 'SYNONYM'" ng-change="updateDescription(description)"
                      ng-model-options="{updateOn: 'blur'}"
                      ng-disabled="isStatic || description.effectiveTime"
                      maxlength="255"
                      ng-model="description.term"
                      class="color_{{relationship.groupId}} msd-elastic" type="text"
                      placeholder="Description">
            </textarea>
            <textarea ng-if="description.type === 'TEXT_DEFINITION'" 
                      
                      ng-change="updateDescription(description)"
                      ng-model-options="{updateOn: 'blur'}"
                     
                      ng-model="description.term" 
                      type="text"
                      placeholder="Description"
                      class="color_{{relationship.groupId}} msd-elastic">
            </textarea>
          </div>

          <!-- TypeId -->
          <div class="pull-left typeid">
            <select ng-disabled="description.effectiveTime || isStatic"
                    ng-options="descTypeId.name as descTypeId.abbr for descTypeId in descTypeIds"
                    ng-model="description.type" ng-change="updateDescription(description)"
                    name="select-type" id="select-type-choice" class="form-control color_{{relationship.groupId}}"
                    ui-on-drop="">
            </select>
          </div>

          <!-- Dialect / Acceptability -- never alterable for FSN -->
          <div>
            <!-- en-us acceptability -->
            <button type="button"
                    class=" blue accent-2 button-width-acceptability custom-button"
                    ng-disabled="isStatic || (description.type === 'FSN' && description.effectiveTime)"
                    title="{{getAcceptabilityTooltipText(description, 'en-us')}} US"
                    ng-click="toggleAcceptability(description, 'en-us')">
              <div
                class="md col-md-12 no-padding text-center">us:
                                                            {{getAcceptabilityDisplayText(description,
                                                            'en-us')}}
              </div>
            </button>

            <!-- en-gb acceptability -->
            <button type="button" class=" blue accent-2 button-width-acceptability custom-button"
                    ng-disabled="isStatic || (description.type === 'FSN' && description.effectiveTime)"
                    title="{{getAcceptabilityTooltipText(description, 'en-gb')}} GB"
                    ng-click="toggleAcceptability(description, 'en-gb')">
              <div
                class="md col-md-12 no-padding text-center">gb:
                                                            {{getAcceptabilityDisplayText(description,
                                                            'en-gb')}}
              </div>
            </button>


          </div>


          <div ng-show="!isStatic">

            <button ng-if="!isStatic" type="button" ng-click="addDescription($index)"
                    class="btn-default add-buttons md fa fa-plus plus-button-width  pull-right tooltips-left tooltips-light normal-case">
              <span>Add New Description</span></button>

            <button type="button" ng-click="removeDescription(description)"
                    ng-if="!description.effectiveTime && !description.released"
                    class="btn-default add-buttons md fa fa-minus plus-button-width  pull-right tooltips-left tooltips-light normal-case">
              <span>Remove Description</span></button>

          </div>

          <div ng-if="description.additionalFields" ng-repeat="field in description.additionalFields">
                <textarea 
               class="msd-elastic resizable-text "
                          ng-model-options="{updateOn: 'blur'}"
                          ng-model="field.value" type="text"
                          placeholder="{{field}}">
                </textarea>
          </div>

        </div>
      </div>
      <div class="row">
        <div class="validation red" ng-repeat="error in validation.errors[description.descriptionId]"><strong>Convention
                                                                                                              Error:</strong>
          {{error}}
        </div>
      </div>
      <div class="row">
        <div class="validation orange darken-1" ng-repeat="warning in validation.warnings[description.descriptionId]">
          <strong>Convention Warning:</strong> {{warning}}
        </div>
      </div>
    </div>

    <!-- rows: Relationships -->
    <div ng-repeat="(groupId, relationshipGroup) in relationshipGroups">
      <div ng-if="showRelationshipGroup(relationshipGroup)">
        <div class="role_group_divider_top_{{groupId}} "></div>
        <div ng-repeat="relationship in relationshipGroup | filter:filterRelationships"
             ng-class="getComponentStyle(relationship.relationshipId, null, '')" class="{{relationship.target.definitionStatus}}">


          <div class="row darken-3 edits-row color_{{relationship.groupId}} "
               ng-class="getComponentStyle(relationship.relationshipId, null, '')">

            <div class="col-md-11 no-padding left-of-edit"
                 drop-channel="relationshipObj"
                 ui-on-drop="dropRelationship(relationship, $data)"
                 drag-enter-class="sca-drag-target"
                 drag-hover-class="sca-drag-hover">

              <div class="">
                <button
                  class="btn-default grey darken-3 md morebuttons more-button-width fa fa-ellipsis-v button-width tooltips-left tooltips-light normal-case"
                  ng-click="setRelationshipProperties(relationship, $event)"
                  popover-template="'shared/component-more/relationshipMore.html'"
                  popover-placement="{{popoverDirection}}"
                  title="Some title here" popover-append-to-body="true"
                  ><span>More details</span></button>

                <button
                  class="btn-default grey darken-3 md morebuttons pull-left md-open-with drag-button-width "
                  ui-draggable="true" drag="relationship" drag-channel="relationshipObj"
                  drag-image="getDragImageForRelationship(relationship)"></button>

                <!-- TODO Fix this   Note: due to weird behavior with ng-class, need to manually add bottom alignment -->
                <button type="button"
                        style="vertical-align: bottom"
                        ng-disabled="isStatic"
                        ng-click="toggleRelationshipActive(relationship)"
                        ng-class="[btn, btn-default, editbuttons, md, 'fa fa-power-off button-width', {green : relationship.active}, {red: !relationship.active}]"
                        title="Active/Inactive"></button>

                <!-- relationship group -->
                <div class="pull-left rolegroup">
            <textarea
              ng-disabled="isStatic"
              ng-model="relationship.groupId"
              ng-model-options="{updateOn: 'blur'}"
              ng-change="updateRelationship(relationship)"
              class=" msd-elastic form-control color_{{relationship.groupId}}" type="text" placeholder="#"
              ui-on-drop="dropNullOp()">
            </textarea>
                </div>

                <!-- attribute type' -->
                <div class="pull-left is_a"
                     drag-enter-class="sca-drag-target"
                     drag-hover-class="sca-drag-hover"
                     drop-channel="conceptPropertiesObj"
                     ui-on-drop="dropRelationshipType(relationship, $data)"
                     drop-validate="!relationship.effectiveTime && !isStatic">
 
            <textarea type="text"
                      ng-model="relationship.type.fsn"
                      ng-disabled="relationship.effectiveTime || isStatic"

                      class="msd-elastic resizable-text "
                      typeahead="suggestion as suggestion.fsn.term for suggestion in allowedAttributes | filter:$viewValue:emptyOrMatch"
                      typeahead-focus-first="false"
                      typeahead-loading="typeTypeaheadLoading"
                      typeahead-wait-ms="700"
                      typeahead-on-select="setRelationshipTypeConceptFromMrcm(relationship, $item)"
                      typeahead-editable="false" typeahead-min-length="0">

            </textarea>
            <span class="pull-left md drag-button-width "
                  ng-class="[{'md-open-with' : !typeTypeaheadLoading}, {'md-cached' : typeTypeaheadLoading}]"
                  ui-draggable="true"
                  drag="getConceptIdNamePairFromAttributeType(relationship)"
                  drag-channel="conceptPropertiesObj"
                  drag-image="getDragImageForConcept(relationship.type.fsn)"></span>

                </div>

                <!-- linked concept -->
                <div class="pull-left sourcename"
                     drag-enter-class="sca-drag-target"
                     drag-hover-class="sca-drag-hover"
                     drop-channel="conceptPropertiesObj"
                     ui-on-drop="dropRelationshipTarget(relationship, $data)"
                     drop-validate="!relationship.effectiveTime && !isStatic">

            <textarea type="text"
                      ng-model="relationship.target.fsn"
                      ng-disabled="relationship.effectiveTime || isStatic"
                      class="msd-elastic resizable-text "
                      typeahead="suggestion as suggestion.tempFsn for suggestion in getConceptsForValueTypeahead(relationship.type.conceptId, $viewValue)"
                      typeahead-loading="targetTypeaheadLoading"
                      typeahead-focus-first="false"
                      typeahead-wait-ms="700"
                      typeahead-on-select="setRelationshipTargetConceptFromMrcm(relationship, $item)"
                      typeahead-editable="false" typeahead-min-length="3"></textarea>
                        <span class="pull-left drag-button-width "
                              ng-class="[{'md-open-with' : !targetTypeaheadLoading}, {'md-cached' : targetTypeaheadLoading}]"
                              ui-draggable="true"
                              drag="getConceptIdNamePairFromRelationshipTarget(relationship)"
                              drag-channel="conceptPropertiesObj"
                              drag-image="getDragImageForConcept(relationship.target.fsn)"></span>
                </div>
              <span ng-if="relationship.target.definitionStatus == 'FULLY_DEFINED'"
                    class="pull-left p-t-5 p-l-3 white-text"><span
                class="badge alert-warning ng-binding">â‰¡&nbsp; </span></span>
              <span ng-if="relationship.target.definitionStatus == 'PRIMITIVE'"
                    class="pull-left  p-t-5 p-l-3 white-text"><span
                class="badge alert-warning ng-binding">&nbsp; </span></span>


                <div ng-if="!isStatic">

                  <button type="button" ng-click="addRelationship(groupId, relationship)"
                          class="btn-default add-buttons md fa fa-plus button-width-plus pull-right tooltips-left tooltips-light normal-case">
                    <span>Add New Relationship</span></button>

                  <button type="button" ng-click="removeRelationship(relationship)"
                          ng-if="!relationship.effectiveTime"
                          class="btn-default add-buttons md fa fa-minus button-width-minus pull-right tooltips-left tooltips-light normal-case">
                    <span>Remove Relationship</span></button>


                </div>


              </div>
              <div ng-if="relationship.additionalFields" ng-repeat="field in relationship.additionalFields">
                <textarea class="msd-elastic resizable-text"
                          ng-model-options="{updateOn: 'blur'}"
                          ng-model="field.value" type="text"
                          placeholder="{{field}}">
                </textarea>
              </div>
            </div>

            <div class="col-md-1 no-padding color_{{relationship.groupId}} role-group-drag p-t-5"
                 drop-channel="relationshipGroupObj"
                 ui-on-drop="dropRelationshipGroup($data)"
                 drag-enter-class="sca-relgroup-drag-target"
                 drag-hover-class="sca-relgroup-drag-hover">
              <button ng-if="$index === 0"
                      class="btn-default md-open-with role-group-buttons tooltips-left tooltips-light normal-case "
                      ui-draggable="true" drag="relationshipGroup" drag-channel="relationshipGroupObj"
                      drag-image="getDragImageForRelationshipGroup(relationshipGroup)">
                <span>Drag Relationship Group</span></button>

              <button ng-if="$index === 0 && !isStatic"
                      ng-if="!isStatic"
                      class="btn-default md-exposure-plus-1 role-group-buttons tooltips-left tooltips-light normal-case "
                      ng-click="addRelationshipGroup()"><span>Add Relationship Group</span></button>
            </div>
          </div>


          <div class="row">
            <div class="validation red" ng-repeat="error in validation.errors[relationship.relationshipId]"><strong>Convention
                                                                                                                    Error:</strong>
              {{error}}
            </div>
          </div>
          <div class="row">
            <div class="validation orange darken-1"
                 ng-repeat="warning in validation.warnings[relationship.relationshipId]">
              <strong>Convention Warning:</strong> {{warning}}
            </div>
          </div>
        </div>
        <div class="role_group_divider_bottom_{{groupId}}"></div>
      </div>
    </div>
    <div class="clearfix"></div>
  </div>
</div>
